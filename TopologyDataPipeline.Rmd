---
title: "TopologyDataPipeline"
author: "Kevin Shin"
date: "5/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
library(tidytext)
library(dplyr)
library(stringr)
library(tokenizers)
library(gutenbergr)
library(rapportools)
library(textstem)
library(text2vec)
library(stopwords)
library(TDA)
library(philentropy)
library(lsa)
library(quanteda)
library(qlcMatrix)
library(irlba)
library(tm)
```

###Load in Data
```{r}
gutenberg_filtered <- gutenberg_metadata %>% filter(is.na(author)==FALSE) %>% filter(is.na(title)==FALSE) %>% filter(has_text == TRUE) %>%  filter(rights == "Public domain in the USA.") %>% filter(language == "en")
```

###Selecting categories
```{r}
topics <- c("Children's Fiction", "Humor", "Science Fiction", "Adventure", "Reference", "Horror")

#returns vector of gutenbergIDs associated with that topic
isolateIDs <- function(category){
  subsetBookshelf <- gutenberg_filtered %>% filter(gutenberg_bookshelf == category)
  bookShelfIDs <- subsetBookshelf$gutenberg_id
  return(bookShelfIDs)
}
```

```{r}
isolateIDs("Humor")
```

```{r}
pipeline <- function(category, numLines){
  bookShieldIDs <- isolateIDs(category)
  mainDataFrame <- data.frame(bookShieldIDs, numHoles = 0)
  
 for (value in bookShieldIDs){
   bookDTM <- computeDTM(value,numLines)
   if (!is.null(bookDTM)){  
   bookDistanceMatrix <- makeDistanceMatrix(bookDTM)
     Diag <- ripsDiag(X = bookDistanceMatrix,
                   maxdimension = 1,
                   maxscale = 100,
                   dist = "arbitrary", 
                   library = "Dionysus",
                   printProgress = FALSE)
     numHoles <- summary.diagram(Diag[["diagram"]])$n
     print(numHoles)
     mainDataFrame$numHoles[mainDataFrame$bookShieldIDs == value] <- numHoles
   }
   else {
     mainDataFrame$numHoles[mainDataFrame$bookShieldIDs == value] <- 0
     print("0 here")
   }
 }
  return(mainDataFrame)
}

View(pipeline("Humor", 10))
```


###Create DTM


```{r}
computeDTM <- function(IDNum, lineLimit){
  book <- gutenberg_download(IDNum, strip=TRUE)
  book <- unnest_tokens(book,input="text",output="Paragraph",token="paragraphs")
  book <- book[20:(20+lineLimit),]
  book <- VCorpus(VectorSource(book$Paragraph))
  book <- tm_map(book, stripWhitespace)
  book <- tm_map(book, content_transformer(tolower))
  book <- tm_map(book, removeWords, stopwords("english"))
  book <- tm_map(book, removePunctuation)
  book <- tm_map(book, stemDocument, language = "english")  
  dtm <- DocumentTermMatrix(book)
  dtm <- weightTfIdf(dtm)
  #print(dim(dtm)[2])
  if ((dim(dtm)[2]) != 0){
    dtmLSA <- lsa(dtm, dims=dimcalc_share())$tk
    return(dtmLSA)
  } else {
    return(NULL)
  }
}

```

```{r}
DTM_1257 <- computeDTM(4682, 50)
DTM_1257
```


###makeDistanceMatrix
```{r}
makeDistanceMatrix <- function(datamatrix){
  distanceMatrix <- datamatrix
  cosineDistMatrix <- cosSparse(distanceMatrix)
  diag(cosineDistMatrix) <- 0
  for(row in 2:nrow(cosineDistMatrix)) {
      cosineDistMatrix[row, row-1] <- 0
      cosineDistMatrix[row-1, row] <- 0 
  }
   for(row in 1:nrow(cosineDistMatrix)) {
     for(col in 1:nrow(cosineDistMatrix)) {
       cosineDistMatrix[row,col] = abs(cosineDistMatrix[row,col])*1000000000000000000
     }
   }
  return(as.matrix(cosineDistMatrix))
}
```

```{r}
##Adventure, Three Musketeers
DTM_1257 <- computeDTM(1257, 50)
DM_1257 <- makeDistanceMatrix(DTM_1257)
print(DM_1257)

##Humor, A Damsel in Distress PG Wodehouse
DTM_2233 <- computeDTM(2233, 50)
DM_2233 <- makeDistanceMatrix(DTM_2233)
print(DM_2233)
```



###Example
```{r}
DTM_1257 <- computeDTM(1257, 120)
DM_1257 <- makeDistanceMatrix(DTM_1257)

Diag1257 <- ripsDiag(X = DM_1257,
                 maxdimension = 1,
                 maxscale = 50,
                 dist = "arbitrary", 
                 library = "Dionysus",
                 printProgress = FALSE)

print(summary.diagram(Diag1257[["diagram"]]))
plot(Diag1257[["diagram"]])
plot(Diag1257[["diagram"]], barcode=TRUE, main="Barcode from DTM_1257")

```

```{r}
DTM_2233 <- computeDTM(2233, 120)
DM_2233 <- makeDistanceMatrix(DTM_2233)

Diag2233 <- ripsDiag(X = DM_2233,
                 maxdimension = 1,
                 maxscale = 4,
                 dist = "arbitrary", 
                 library = "Dionysus",
                 printProgress = FALSE)

print(summary.diagram(Diag2233[["diagram"]]))
plot(Diag2233[["diagram"]])
print(Diag2233[["diagram"]])
plot(Diag2233[["diagram"]], barcode=TRUE, main="Barcode from DTM_2233")

```


```{r}
DTM_2233 <- computeDTM(30324, 120)
DM_2233 <- makeDistanceMatrix(DTM_2233)

Diag2233 <- ripsDiag(X = DM_2233,
                 maxdimension = 1,
                 maxscale = 1,
                 dist = "arbitrary", 
                 library = "Dionysus",
                 printProgress = FALSE)

print(summary.diagram(Diag2233[["diagram"]]))
plot(Diag2233[["diagram"]])
plot(Diag2233[["diagram"]], barcode=TRUE, main="Barcode from DTM_30324")


```
